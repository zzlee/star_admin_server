<!DOCTYPE HTML>
<html>
  <head>
    <script src="./jquery-2.0.3.min.js"></script>
    <style>
        body {
            margin: 0px;
            padding: 0px;
        }
    </style>
  </head>
  <body>
    <canvas id="myCanvas"></canvas>
    <script>
        var option = {};
        var strUrl = location.search;
        strUrl = strUrl.replace('?', '');
        var query = strUrl.split('&');

        for(var i=0; i<query.length; i++) {
            var temp = query[i].split('=');
            option[temp[0]] = temp[1];
        }

        //var source = 'https://s3.amazonaws.com/miix_content/user_project/check_in-5248f77955ebecec1100000b-1380618600000-001-1380618827113/check_in-5248f77955ebecec1100000b-1380618600000-001-1380618827113.jpg';
        var source = option.sourceImage;
        var icon = 'https://lh5.googleusercontent.com/-qB0YcnpbZI8/Ul0oE5I8juI/AAAAAAAAABM/QVLp-J0zG9A/s0/black_icon.png';

        var canvas = document.getElementById('myCanvas');
        var context = canvas.getContext('2d');
        var imageObj = new Image();
        var imageIcon = new Image();

        imageObj.onload = function() {
            canvas.width = imageObj.width;
            canvas.height = imageObj.height;
            context.drawImage(imageObj, 0, 0);
            context.drawImage(imageIcon, 0, 0);
            
            context.font = 'bold 48px 微軟正黑體';
            context.fillStyle = 'white';
            context.textAlign="right";
            context.fillText(decodeURI(option.textContent), canvas.width-186, 1164);

            context.save();
            // alert(canvas.toDataURL());
            textImageComplete(option.accessToken, canvas.toDataURL());
            
        };
        
        var textImageComplete = function(access_token, data){
            $.post( "http://127.0.0.1/fb/image_uplaod/base64", { access_token: access_token, image: data }, function( data ){
                // alert('data load: ' + data);
                window.close();
            });
        };
        
        var img64Loader = function(imgURL, img64load_cb){
            $.ajax({
                url: 'http://img64.com/?q=' + encodeURIComponent(imgURL),
                dataType: 'jsonp'
            }).then(function (image) {
                img64load_cb(image.data);
            });
        };
        
        img64Loader(icon, function(icondata){
            imageIcon.src = icondata;
            img64Loader(source, function(sourcedata){
                imageObj.src = sourcedata;
            });
        });

    </script>
  </body>
</html>



